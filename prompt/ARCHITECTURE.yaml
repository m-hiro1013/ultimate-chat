architecture:
  version: "1.2.0"
  description: "Ultimate Chat の論理構成とデータフロー（Revitalized Edition）"

  core_flow:
    input: "InputArea.tsx -> handleFileUpload -> readTextFileWithLimit (lib/file-utils.ts) -> useChat (app/page.tsx)"
    processing:
      intent_detection: "lib/mode-detector.ts (AI-based Intent classification excluding attachment content)"
      orchestration: "lib/orchestrator.ts (Message trimming -> Dynamic prompt building -> tool-aware streamText)"
      prompt_construction: "lib/prompt-builder.ts (System base + Mode specific + File analysis prompts)"
    output: "MessageParts.tsx (Markdown rendering + Thinking logs + Source citations + File links)"

  data_management:
    persistence: "Dexie.js (IndexedDB) -> browser-local storage for conversations and history"
    memory_strategy:
      long_term: "lib/db/preferences.ts (User customized instructions)"
      mid_term: "app/api/summarize/route.ts (Automatic periodic summarization via LLM)"
      short_term: "lib/orchestrator.ts (Token-aware message history windowing)"

  safety_guards:
    hallucination_prevention: "prompts/file-analysis.ts (Strict data-first instructions)"
    error_recovery: "lib/orchestrator.ts (Exponential backoff retry + Graceful tool failure fallback)"

  tech_stack:
    framework: "Next.js 16.1.6 (Turbopack)"
    llm_integration: "AI SDK v6 (@ai-sdk/google, @ai-sdk/react)"
    language_safety: "TypeScript 5.x with Strict Null Checks"
    styling: "Tailwind CSS 4.x"

completed_features:
  revitalization_phase:
    name: "Ultimate Chat Revitalization"
    status: "done"
    completed_at: "2026-02-08"
    features:
      - id: "FIX01"
        name: "高精度ファイル添付処理"
        description: "テキストファイルの完全な読み取りと Gemini への正確なコンテキスト受け渡し"
        file: "lib/file-utils.ts"
      - id: "FIX02"
        name: "意図分析におけるファイルノイズ除去"
        description: "モード判定時に巨大なファイル内容を無視し、質問者の意図を正確に抽出"
        file: "lib/mode-detector.ts"
      - id: "FIX03"
        name: "サーバーサイド DB 依存の排除"
        description: "API Route から IndexedDB 呼び出しを削除し、クライアントサイド管理へ完全移行"
        file: "app/api/chat/route.ts, lib/context-manager.ts"
      - id: "FIX04"
        name: "AI SDK v6 型安全性の強化"
        description: "streamText やツール定義における型エラーの体系的解消"
        file: "lib/orchestrator.ts, lib/tools/deep-research.ts"
